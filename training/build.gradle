// "basic" configuration in it

apply plugin: 'groovy'
apply plugin: 'java'

group 'de.dfki.mary'
version '0.5.2-SNAPSHOT'

repositories {
    mavenCentral()
}


dependencies {
    compile "org.codehaus.groovy:groovy-all:2.2"
}


import groovy.json.* // To load the JSON configuration file
import java.util.*


def slurper = new JsonSlurper()
def config_file =  new File(System.getProperty("configuration"))
def config = slurper.parseText( config_file.text )


apply plugin: "de.dfki.mary.htsvoicebuilding"

(new File(DataFileFinder.getFilePath(config.data.list_files))).eachLine{ basename ->
    project(":$basename") {
        buildDir = project.parent.buildDir
        apply plugin: "de.dfki.mary.coefficientextraction"
    }
}

task prepareData() {
    (new File(DataFileFinder.getFilePath(config.data.list_files))).eachLine { basename ->
        dependsOn ":${basename}:generateCMP"
    }

    /* We have also to adapt a little bit the coefficient paths */
    project.user_configuration.models.cmp.streams.each { stream ->
        stream.coeffDir = "$project.buildDir/${stream.coeffDir}"
    }
}

task finalize(dependsOn: run) {
    doLast {
        // Copy configuration file
        copy {
            from config_file.getParent()
            to "$buildDir/raw"
            include config_file.getName()
        }

        // Creating win directory
        (new File("$buildDir/raw/win")).mkdirs()

        //
        project.user_configuration.models.cmp.streams.each { stream ->
            stream.winfiles { winfilename ->
                def winfile = new File(DataFileFinder.getFilePath(winfilename))
                copy {
                    from winfile.getParent()
                    to "$buildDir/raw/win"
                    include winfile.getName()
                }
            }
        }
    }
}

build.dependsOn finalize